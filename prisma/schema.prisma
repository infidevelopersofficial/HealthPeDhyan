// This is your Prisma schema file

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTH
// ============================================================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  role         UserRole @default(EDITOR)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  articles Article[]

  @@index([email])
  @@map("users")
}

enum UserRole {
  ADMIN
  EDITOR
}

// ============================================================================
// PRODUCTS & BRANDS
// ============================================================================

model Brand {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]

  @@index([slug])
  @@map("brands")
}

model Category {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]

  @@index([slug])
  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  brandId     String
  categoryId  String
  description String?  @db.Text
  heroImage   String?
  galleryJson Json?    @db.JsonB
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Nutrition & Ingredients
  shortSummary    String?   @db.Text
  nutritionJson   Json?     @db.JsonB
  ingredientsText String?   @db.Text
  allergensText   String?   @db.Text
  healthScore     Int       @default(0)
  searchVector    String?   @db.Text

  // Health Flags
  isPalmOilFree          Boolean @default(false)
  isArtificialColorFree  Boolean @default(false)
  isLowSugar             Boolean @default(false)
  isWholeGrain           Boolean @default(false)
  isMeetsStandard        Boolean @default(false)

  // Relations
  brand           Brand             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category        Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  badges          ProductBadge[]
  ingredientFlags ProductIngredientFlag[]
  affiliateLinks  AffiliateLink[]

  @@index([slug])
  @@index([brandId])
  @@index([categoryId])
  @@index([isPalmOilFree])
  @@index([isArtificialColorFree])
  @@index([isLowSugar])
  @@index([isMeetsStandard])
  @@map("products")
}

// ============================================================================
// BADGES & FLAGS
// ============================================================================

model Badge {
  id          String         @id @default(cuid())
  name        String
  code        String         @unique
  description String?        @db.Text
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  products    ProductBadge[]

  @@index([code])
  @@map("badges")
}

model ProductBadge {
  id        String   @id @default(cuid())
  productId String
  badgeId   String
  rationale String?  @db.Text
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  badge   Badge   @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([productId, badgeId])
  @@index([productId])
  @@index([badgeId])
  @@map("product_badges")
}

model IngredientFlag {
  id          String                  @id @default(cuid())
  name        String
  code        String                  @unique
  description String?                 @db.Text
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  products    ProductIngredientFlag[]

  @@index([code])
  @@map("ingredient_flags")
}

model ProductIngredientFlag {
  id        String   @id @default(cuid())
  productId String
  flagId    String
  createdAt DateTime @default(now())

  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  flag    IngredientFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@unique([productId, flagId])
  @@index([productId])
  @@index([flagId])
  @@map("product_ingredient_flags")
}

// ============================================================================
// AFFILIATE LINKS
// ============================================================================

model AffiliateLink {
  id         String            @id @default(cuid())
  productId  String
  merchant   AffiliateMerchant
  url        String
  paramsJson Json?             @db.JsonB
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([merchant])
  @@map("affiliate_links")
}

enum AffiliateMerchant {
  AMAZON
  FLIPKART
  OTHER
}

// ============================================================================
// ARTICLES & BLOG
// ============================================================================

model Article {
  id           String        @id @default(cuid())
  slug         String        @unique
  title        String
  excerpt      String?       @db.Text
  bodyMarkdown String        @db.Text
  coverImage   String?
  videoUrl     String?
  category     String?
  tags         String?
  status       ArticleStatus @default(DRAFT)
  metaJson     Json?         @db.JsonB
  publishedAt  DateTime?
  canonicalUrl String?
  authorId     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  author User? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@map("articles")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

// ============================================================================
// EVIDENCE LIBRARY
// ============================================================================

model Evidence {
  id        String   @id @default(cuid())
  title     String
  publisher String?
  year      Int?
  url       String?
  summary   String?  @db.Text
  tagsJson  Json?    @db.JsonB
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year])
  @@map("evidence")
}

// ============================================================================
// INGREDIENTS
// ============================================================================

model Ingredient {
  id             String         @id @default(cuid())
  name           String
  slug           String         @unique
  description    String?        @db.Text
  aliasesJson    Json?          @db.JsonB
  riskLevel      RiskLevel      @default(LOW)
  referencesJson Json?          @db.JsonB
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([slug])
  @@index([riskLevel])
  @@map("ingredients")
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
}
